# TurboLoader v0.3.0 Release Notes

**Release Date**: 2025-01-15
**Status**: Implementation Complete
**Focus**: WebDataset API, Multi-Format Support, Data Augmentation

---

## Overview

Version 0.3.0 represents a major feature release that adds three key capabilities to TurboLoader:

1. **PyTorch-Compatible Iterator API** - Seamless integration with existing ML workflows
2. **Multi-Format Image Support** - PNG and WebP decoders with SIMD optimizations
3. **SIMD-Accelerated Augmentations** - High-performance data augmentation transforms

This release maintains TurboLoader's performance-first philosophy while significantly improving usability and flexibility.

---

## New Features

### 1. WebDataset Iterator API

**File**: `python/webdataset_loader.py` (380 lines)

A drop-in replacement for PyTorch DataLoader with full WebDataset format support:

```python
from turboloader import WebDatasetLoader

# Create loader with PyTorch-style API
loader = WebDatasetLoader(
    urls=['imagenet-{000000..001281}.tar'],
    batch_size=256,
    num_workers=8,
    shuffle=True,
    transforms=[...]
)

# Iterate like PyTorch DataLoader
for epoch in range(100):
    for batch in loader:
        images, labels = batch['image'], batch['label']
        # Training code...
```

**Key Features**:
- ✅ Full `__iter__` and `__len__` protocol support
- ✅ URL pattern expansion (`data-{000..999}.tar`)
- ✅ Custom collate functions
- ✅ Distributed training with `DistributedWebDatasetLoader`
- ✅ Automatic epoch reset and state management
- ✅ Drop last batch support

**Implementation**: Complete Python implementation wrapping existing C++ Pipeline

### 2. Multi-Format Image Decoding

**Files**: `src/decoders/png_decoder.cpp`, `src/decoders/webp_decoder.cpp`

Support for PNG and WebP images in addition to JPEG:

| Format | Decoder | SIMD Support | Status |
|--------|---------|--------------|--------|
| JPEG | libjpeg-turbo | ✅ AVX2/NEON | Complete (v0.1.0) |
| PNG | libpng | ⚠️ Limited | ✅ Complete (v0.3.0) |
| WebP | libwebp | ✅ SSE2/NEON | ✅ Complete (v0.3.0) |

**PNG Decoder** (143 lines):
- Magic byte detection (`89 50 4E 47 0D 0A 1A 0A`)
- Thread-local decoder instances
- Support for all bit depths
- Lossless decompression

**WebP Decoder** (68 lines):
- RIFF/WEBP magic byte detection
- SIMD-accelerated decoding (libwebp)
- Support for lossy and lossless WebP
- Alpha channel handling

### 3. Data Augmentation Transforms

**Files**:
- `include/turboloader/transforms/augmentation_transforms.hpp` (295 lines)
- `src/transforms/augmentation_transforms.cpp` (1000+ lines)
- `python/turboloader_py.cpp` (augmentation bindings, 110+ lines)

Seven SIMD-optimized augmentation transforms with a composable pipeline:

#### **RandomHorizontalFlip**
```python
flip = turboloader.RandomHorizontalFlip(probability=0.5)
```
- SIMD-optimized horizontal mirroring
- AVX2 implementation processes 10 pixels at once (RGB)
- NEON implementation processes 5 pixels at once
- Probability-based application

#### **RandomVerticalFlip**
```python
vflip = turboloader.RandomVerticalFlip(probability=0.5)
```
- Fast row-swapping implementation
- Efficient memory layout
- Configurable probability

#### **ColorJitter**
```python
jitter = turboloader.ColorJitter(
    brightness=0.2,
    contrast=0.2,
    saturation=0.1,
    hue=0.0
)
```
- SIMD-optimized brightness, contrast, and saturation adjustments
- AVX2 processes 8 pixels per iteration
- NEON optimized for ARM processors
- Randomized parameter sampling

#### **RandomRotation**
```python
rotate = turboloader.RandomRotation(degrees=15.0)
rotate.set_fill_color(0, 0, 0)  # Black background
```
- Bilinear interpolation with SIMD
- Configurable rotation range
- Custom fill color for out-of-bounds pixels
- Center-based rotation

#### **RandomCrop**
```python
crop = turboloader.RandomCrop(crop_width=224, crop_height=224)
```
- Efficient in-place crop extraction
- Random position selection
- Cache-friendly implementation

#### **RandomErasing (Cutout)**
```python
erasing = turboloader.RandomErasing(
    probability=0.5,
    scale_min=0.02,
    scale_max=0.33,
    ratio_min=0.3,
    ratio_max=3.3
)
```
- Cutout augmentation implementation
- Configurable area and aspect ratio
- Random fill values

#### **GaussianBlur**
```python
blur = turboloader.GaussianBlur(sigma=1.0, kernel_size=5)
blur.set_sigma_range(0.1, 2.0)  # Random sigma
```
- Separable Gaussian filter (horizontal + vertical passes)
- SIMD-optimized convolution
- Configurable kernel size and sigma range
- Automatic kernel normalization

#### **AugmentationPipeline**
```python
pipeline = turboloader.AugmentationPipeline(seed=42)
pipeline.add_transform(turboloader.RandomHorizontalFlip(0.5))
pipeline.add_transform(turboloader.ColorJitter(0.2, 0.2, 0.1, 0.0))
pipeline.add_transform(turboloader.RandomRotation(15.0))

# Apply all transforms to image data
pipeline.apply_all(data, width, height, channels)
```
- Composable transform chain
- Deterministic with seeding support
- Thread-safe RNG per pipeline
- Configurable probability per transform

---

## Performance Characteristics

### SIMD Optimizations

All augmentation transforms leverage SIMD instructions where applicable:

| Transform | x86_64 SIMD | ARM SIMD | Speedup |
|-----------|-------------|----------|---------|
| Horizontal Flip | AVX2 (32 bytes) | NEON (16 bytes) | ~4-8x |
| Color Jitter (Brightness) | AVX2 (8 pixels) | NEON (4 pixels) | ~3-6x |
| Color Jitter (Contrast) | AVX2 (8 pixels) | NEON (4 pixels) | ~3-6x |
| Color Jitter (Saturation) | AVX2 (partial) | NEON (4 pixels) | ~2-4x |
| Gaussian Blur | AVX2 (separable) | Scalar | ~2-3x |

### Memory Efficiency

- **Zero-copy where possible**: Transforms operate in-place on existing buffers
- **Thread-local decoders**: No contention between worker threads
- **Minimal allocations**: Temporary buffers only for rotation and blur

### Augmentation Overhead

Target overhead: **<10% slowdown** compared to no augmentation

---

## API Changes

### New Python Classes

```python
# Iterator API
from turboloader import WebDatasetLoader, DistributedWebDatasetLoader

# Augmentation transforms
from turboloader import (
    RandomHorizontalFlip,
    RandomVerticalFlip,
    ColorJitter,
    RandomRotation,
    RandomCrop,
    RandomErasing,
    GaussianBlur,
    AugmentationPipeline
)

# Config class now exposed
from turboloader import Config
```

### Enhanced Config Object

```python
config = turboloader.Config()
config.num_workers = 8
config.queue_size = 256
config.shuffle = True
config.decode_jpeg = True
config.enable_simd_transforms = True
```

---

## Usage Examples

### Example 1: Basic WebDataset Loading

```python
from turboloader import WebDatasetLoader

loader = WebDatasetLoader(
    urls=['train-{000..127}.tar'],
    batch_size=256,
    num_workers=16,
    shuffle=True
)

for batch in loader:
    images = batch['jpg']  # or batch['png'], batch['webp']
    labels = batch['cls']
    # Training...
```

### Example 2: Distributed Training

```python
import torch.distributed as dist
from turboloader import DistributedWebDatasetLoader

dist.init_process_group(backend='nccl')

loader = DistributedWebDatasetLoader(
    urls=['imagenet-{000000..001281}.tar'],
    batch_size=256,
    rank=dist.get_rank(),
    world_size=dist.get_world_size(),
    num_workers=8
)

for batch in loader:
    # Each GPU gets different data
    images, labels = batch['image'], batch['label']
```

### Example 3: Augmentation Pipeline

```python
from turboloader import (
    AugmentationPipeline,
    RandomHorizontalFlip,
    ColorJitter,
    RandomRotation,
    GaussianBlur
)

# Create augmentation pipeline
aug = AugmentationPipeline(seed=42)
aug.add_transform(RandomHorizontalFlip(0.5))
aug.add_transform(ColorJitter(0.2, 0.2, 0.1, 0.0))
aug.add_transform(RandomRotation(15.0))
aug.add_transform(GaussianBlur(1.0, 5))

# Use in WebDataset loader
loader = WebDatasetLoader(
    urls=['data.tar'],
    batch_size=32,
    num_workers=4,
    transforms=[aug]  # Apply augmentations
)
```

### Example 4: Multi-Format Dataset

```python
# Automatically handles JPEG, PNG, and WebP images
loader = WebDatasetLoader(
    urls=['mixed-format-{00..99}.tar'],
    batch_size=64,
    num_workers=8,
    decode_jpeg=True  # Auto-detects and decodes all formats
)

for batch in loader:
    # Works seamlessly with any image format
    images = batch.get('jpg') or batch.get('png') or batch.get('webp')
```

---

## Breaking Changes

**None** - v0.3.0 is fully backwards compatible with v0.2.x

All existing code continues to work:

```python
# Old API (still supported)
pipeline = turboloader.Pipeline(['data.tar'], config)
pipeline.start()
batch = pipeline.next_batch(256)
```

---

## Migration Guide

### From v0.2.x to v0.3.0

No migration required! New features are additive:

```python
# Before (v0.2.x) - Still works
from turboloader import Pipeline, Config
pipeline = Pipeline(['data.tar'], Config())

# After (v0.3.0) - New recommended way
from turboloader import WebDatasetLoader
loader = WebDatasetLoader(urls=['data.tar'], batch_size=32)
for batch in loader:
    # Process batch...
```

### Recommended Upgrade Path

1. **Update imports** to use `WebDatasetLoader` for new code
2. **Add augmentations** using `AugmentationPipeline`
3. **Enable multi-format** support if using PNG/WebP images
4. **Consider distributed** training with `DistributedWebDatasetLoader`

---

## Build and Installation

### From Source

```bash
git clone https://github.com/arnavjain/turboloader.git
cd turboloader
mkdir build && cd build
cmake ..
make -j$(nproc)
python3 -m pip install ..
```

### Dependencies

New dependencies for v0.3.0:
- **libpng** (for PNG decoding)
- **libwebp** (for WebP decoding)

Install on macOS:
```bash
brew install libpng webp
```

Install on Ubuntu:
```bash
sudo apt-get install libpng-dev libwebp-dev
```

---

## Testing

### Verification

```python
import turboloader

print(f"Version: {turboloader.__version__}")  # Should be 0.3.0

# Test augmentation classes
flip = turboloader.RandomHorizontalFlip(0.5)
jitter = turboloader.ColorJitter(0.2, 0.2, 0.1, 0.0)
pipeline = turboloader.AugmentationPipeline()

print("✓ All v0.3.0 features available!")
```

### Running Tests

```bash
cd build
./tests/turboloader_tests
./tests/test_transforms
```

---

## Known Limitations

1. **Augmentation Pipeline Integration**: Augmentations currently applied per-sample, not batched
2. **Format Auto-Detection**: Basic magic byte detection, may need explicit format specification for edge cases
3. **SIMD Coverage**: Some augmentations (rotation, saturation) have limited SIMD optimizations

These will be addressed in future releases.

---

## Benchmarks

Preliminary benchmarks (full suite in progress):

| Operation | Throughput | Notes |
|-----------|------------|-------|
| JPEG Decode | 5000+ img/s | Existing (v0.1.0) |
| PNG Decode | 1000-2000 img/s | New in v0.3.0 |
| WebP Decode | 2000-3000 img/s | New in v0.3.0 |
| Horizontal Flip (SIMD) | 10000+ img/s | New in v0.3.0 |
| Color Jitter (SIMD) | 8000+ img/s | New in v0.3.0 |
| Full Augmentation Pipeline | 3000-5000 img/s | 4 transforms |

*Benchmarks on Apple M1 Max, 256x256 RGB images*

---

## Future Roadmap (v0.4.0+)

- **GPU-accelerated augmentations** using CUDA
- **Additional formats** (TIFF, BMP, HEIF)
- **Advanced augmentations** (MixUp, CutMix, AutoAugment)
- **TensorFlow/JAX bindings**
- **Cloud storage backends** (S3, GCS)
- **Streaming datasets** for infinite data

---

## Contributors

- Arnav Jain ([@arnavjain](https://github.com/arnavjain))

---

## Changelog

### v0.3.0 (2025-01-15)

**Added**:
- WebDataset iterator API with PyTorch compatibility
- PNG decoder with libpng integration
- WebP decoder with libwebp integration
- RandomHorizontalFlip augmentation (SIMD)
- RandomVerticalFlip augmentation
- ColorJitter augmentation (SIMD brightness/contrast/saturation)
- RandomRotation augmentation with bilinear interpolation
- RandomCrop augmentation
- RandomErasing (Cutout) augmentation
- GaussianBlur augmentation with separable filter (SIMD)
- AugmentationPipeline for composable transforms
- DistributedWebDatasetLoader for multi-GPU training
- Config class Python bindings
- Comprehensive design documentation

**Changed**:
- Updated version to 0.3.0
- Enhanced Python bindings with all new classes

**Fixed**:
- Missing `#include <iostream>` in thread_pool.cpp and pipeline.cpp

---

## License

MIT License - see LICENSE file for details

---

## Acknowledgments

- libjpeg-turbo team for JPEG decoding
- libpng team for PNG decoding
- libwebp team for WebP decoding
- PyTorch team for DataLoader API inspiration
- WebDataset project for format specification

---

**For questions, issues, or feature requests, please visit:**
https://github.com/arnavjain/turboloader/issues
